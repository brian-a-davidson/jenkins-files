#!/usr/bin/env groovy

pipeline {
   
  agent {
    docker {
      reuseNode true
      image 'nonanom/release-tools:latest'
    }
  }

  environment {
    VAULT_ADDR="http://20.118.176.12:8200"
    VAULT_MBO_PATH="cubbyhole/hazelcast"
    VAULT_APP_PATH="cubbyhole/hazelcast/version"
    VAULT_SKIP_VERIFY="true"
    ROLE_ID=credentials('vault-role-id')
    SECRET_ID=credentials('vault-secret-id')
    APP_VERSION="${params.VERSION}"
    APP_NAME="springbootadmin"
    NAMESPACE="default"
    IMAGE="image=azure_registry.azurecr.io/test/springbootadmin:${APP_VERSION}"
    TIMEOUT_VALUE="5m"
  }

  stages {
	  
	 stage('Login') {
      steps {
        sh '''
        vault login $(vault write -format=json auth/approle/login role_id=${ROLE_ID} secret_id=${SECRET_ID} | jq -r .auth.client_token)

        CLIENT_ID=$(vault kv get -field=azure_application_id ${VAULT_MBO_PATH}/azure)
        '''
      		}
	}
  }

  post {
    cleanup {
      deleteDir()
    }
  }
}
